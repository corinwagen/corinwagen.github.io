<!DOCTYPE html>
<html>
  <head>
    <title>
      Blog
    </title>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="language" content="en">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="../../static/style.css">

    <link rel="alternate" type="application/rss+xml" title="RSS feed for the blog" href="/rss.xml">

    <!--google-->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MTNZ0ZSG3W"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-MTNZ0ZSG3W');
    </script>

  </head>
  <body>
    <ul class="menu-list">
      <li class="menu-item"><a href="index.html" class="menu-link menu-title">Corin Wagen</a></li>
      <li class="menu-item"><a href="index.html#about" class="menu-link">About</a></li>
      <li class="menu-item"><a href="index.html#projects" class="menu-link">Projects</a></li>
      <!--<li class="menu-item"><a href="index.html#past_work" class="menu-link">Past Work</a></li>-->
      <li class="menu-item">
        <a href="blog_p1.html" class="menu-link">Blog</a>
        <a href='archive.html' class="menu-link">(Archive)</a>
      </li>
    </ul>
    <h1 class='blogroll-header'>Blog</h1><div class='previous-link'><a href='blog_p1.html'>previous page</a></div><div class='next-link'><a href='blog_p3.html'>next page</a></div><br><div class='blogroll-container'><h2><a class='blogroll-title' href='../../public/blog/20230123_integral_screening.html'>The Importance of Integral Screening</a></h2><i>January 23, 2023</i>
<p>
For almost all Hartree–Fock-based computational methods, including density-functional theory, the rate-limiting step is calculating electron–electron repulsion. (This isn’t true for semiempirical methods, where matrix diagonalization is generally rate-limiting, or for <a href=https://pubs.acs.org/doi/10.1021/acs.jctc.2c00876>calculations on very large systems</a>.)
</p>

<p>
When isolated single molecules are the subject of calculations (as opposed to solids or periodic systems), most programs describe electronic structure in terms of atom-centered basis sets, which reduces the electron–electron repulsion problem to one of calculating electron repulsion integrals (ERIs) over quartets of basis shells. Framed this way, it becomes obvious why ERIs are the bottleneck: the number of ERIs will scale as O(N<sup>4</sup>), meaning that millions of these integrals must be calculated even for relatively small molecules.
</p>

<figure>
  <img class="centered-img" src="../img/20230125_dalle.png" style="width:350px;" />
  <figcaption> 
  I tried to get DALL-E to make a visual representation of integral screening; this was the best I got.
  </figcaption>
</figure>

<p>
One big advance in electronic structure calculations was the development of integral screening techniques, the most popular of which is the “Schwartz inequality” (derived from the <a href=https://en.wikipedia.org/wiki/Cauchy%E2%80%93Schwarz_inequality>Cauchy–Schwartz inequality</a>, but actually developed by <a href=https://onlinelibrary.wiley.com/doi/10.1002/jcc.540100111>Mario Häser and Reinhart Ahlrichs</a>). If we denote an ERI over shells A, B, C, and D as (AB|CD), then the Schwartz inequality says:
</p>

<p>
(AB|CD) ≤ (AB|AB)<sup>0.5</sup> (CD|CD)<sup>0.5</sup>
</p>

<p>
This is pretty intuitive: each shell pair will interact with itself most, since it has perfect overlap with itself, and so the geometric mean of the interaction of each shell pair with itself is an upper bound for the interaction between the two shell pairs. (Why would (AB|AB) ever be a small value? Well, A and B might be super far away from each other, and so the “shell pair” has very little overlap is just negligible.)
</p>

<p>
This result is very useful. Since there are many fewer integrals of the form (AB|AB), we can start by calculating all of those, and then use the resulting values to “screen” each shell quartet. If the predicted value is less than some predefined cutoff, the integral is skipped. While these screening methods don’t help much with small molecules, where all of the shells are pretty close to each other, they become crucial for medium-sized molecules and above.
</p>

<p>
(What’s the cutoff value? Orca defaults to 10<sup>-8</sup>, <a href=https://gaussian.com/integral/>Gaussian</a> to 10<sup>-12</sup>, <a href=https://psicode.org/psi4manual/master/autodir_options_c/module__scf.html>Psi4</a> to 10<sup>-12</sup>, and <a href=https://manual.q-chem.com/5.2/Ch4.S3.SS2.html>QChem</a> to 10<sup>-8</sup>–10<sup>-10</sup> depending on the type of calculation.)
</p>

<p>
The Schwartz inequality neglects, however, another way in which (AB|CD) might be very small: if (AB| and |CD) aren’t independently negligible, but are just really far away from each other. One elegant way to address this (out of many) comes from recent-ish work by <a href=https://aip.scitation.org/doi/10.1063/1.4994190>Travis Thompson and Christian Ochsenfeld</a>. They define an intermediate quantity M for each pair of shells, derived from different high-symmetry integrals:
</p>

<p>
M<sub>AC</sub> := (AA|CC) /  ( (AA|AA)<sup>0.5</sup> (CC|CC)<sup>0.5</sup> )
</p>

<p>
M<sub>AC</sub> intuitively represents the distance between the two shells, and is guaranteed to be in the range [0,1]. Thompson and Ochsenfeld then use this quantity to propose an estimate of a shell quartet’s value:
</p>

<p>
(AB|CD) ≈ (AB|AB)<sup>0.5</sup> (CD|CD)<sup>0.5</sup> max(M<sub>AC</sub>M<sub>BD</sub>, M<sub>AD</sub>M<sub>BC</sub>)
</p>

<p>
This is no longer a rigorous upper bound like the Schwartz inequality, but it’s a pretty good estimate of the size of the integral.
</p>

How much of a difference does this make in practice? To test this, I ran HF/STO-3G calculations on dodecane in the fully linear configuration. As shown by <a href=https://onlinelibrary.wiley.com/doi/10.1002/jcc.540030314>Almlöf, Faegri, and Korsell</a>, linear molecules benefit the most from integral screening (since the shells are on average farther apart), so I hoped to see a sizable effect without having to study particularly large molecules.
</p>

<figure>
  <img class="centered-img" src="../img/20230125_graph.png" style="width:450px;" />
  <figcaption> 
  Almlöf, Faegri, and Korsell, Figure 5. This paper is terrific.
  </figcaption>
</figure>

<p>
I compared both the Schwartz (“QQ”) bound and Ochsenfeld’s CSAM bound for integral thresholds ranging from 10<sup>-9</sup> to 10<sup>-13</sup>, and compared the result to a calculation without any integral screening. The total time for the calculation, as a percent of the unscreened time, is plotted below against the error in µHartree (for the organic chemists out there, 1 µH = 0.00063 kcal/mol):
</p>

<figure>
  <img class="centered-img" src="../img/20230125_graph2.png" style="width:400px;" />
  <figcaption> 
  Comparing CSAM and QQ.
  </figcaption>
</figure>

<p>
A few things are apparent for this data. First, even tight thresholds lead to dramatic speedups relative to the unscreened calculation—and with minimal errors. Secondly, the CSAM bound really does work better than the QQ bound (especially if you ignore the high-error 10<sup>-9</sup> threshold data point). For most threshold values, using CSAM leads to about a 20% increase in speed, at the cost of a 3-fold increase in an already small error. Viewed visually, we can see that the Pareto frontier for CSAM (blue) is just closer to the optimal bottom-left corner than the corresponding frontier for QQ (black).
</p>

<p>
I hope this post serves to explain some of the magic that goes on behind the scenes to make “routine” QM calculations possible. (If you thought these tricks were sneaky, wait until you hear how the integrals that aren’t screened out are calculated!)
</p>

</div><div class='blogroll-container'><h2><a class='blogroll-title' href='../../public/blog/20230118_meta_optimization.html'>Who Will Optimize The Optimizers?</a></h2><i>January 18, 2023</i>

<p>
While looking over papers from the past year, one theme in particular stood out to me: meta-optimization, or optimizing how we optimize things.
</p>

<figure>
  <img class="centered-img" src="../img/20230118_algo.png" style="width:450px;" />
  <figcaption> 
  A generic optimization (image credit to <a href="https://mpalaourg.me/project/optimization-algorithms/">Georgios Balaouras</a>).
  </figcaption>
</figure>

<p>
Meta-optimization has long been a focus of research in computer science, where new optimization algorithms can have an incredibly high impact (e.g. <a href=https://arxiv.org/pdf/1412.6980.pdf>ADAM</a>, one of the most commonly used optimizers for neural network training). More recently, the advent of directed evolution has made optimization methods a central focus of biocatalysis, since (in many cases) the efficacy of the reaction one discovers is primarily dependent on the efficacy of the optimization method used.
</p>

<p>
In contrast, it seems that meta-optimization has historically attracted less attention from “classic” organic chemists, despite the central importance of reaction optimization to so much of what we do. This post aims to show some of the ways in which this paradigm is changing, and briefly summarize some of what I consider to be the most interesting and exciting recent advances in chemical meta-optimization.
<i>(This is a big and somewhat nebulous area, and I am certainly leaving things out or not paying due homage to everyone. Sorry in advance!)</i>
</p>

<h3>Design of Experiments, and Dealing with Discrete Variables</h3>
<p>
Perhaps the best-known optimization algorithm in chemistry is “design of experiments” (DoE), which uses statistical methods to estimate the shape of a multiparameter surface and find minima or maxima more efficiently than one-factor-at-a-time screening. (DoE is a pretty broad term that gets used to describe a lot of different techniques: for more reading, <a href=https://en.wikipedia.org/wiki/Response_surface_methodology>see</a> <a href=https://en.wikipedia.org/wiki/Central_composite_design>these</a> <a href=https://en.wikipedia.org/wiki/Box%E2%80%93Behnken_design>links</a>.)
</p>

<p>
DoE has been used for a long time, <a href=https://pubs.acs.org/doi/full/10.1021/op500169m>especially in process chemistry</a>, and is very effective at optimizing continuous variables (like temperature, concentration, and equivalents). However, it’s less obvious how DoE might be extended to discrete variables. (<a href=https://pubs.acs.org/doi/pdf/10.1021/ol1020898>This 2010 report</a>, from scientists at Eli Lilly, reports the use of DoE to optimize a palladium-catalyzed pyrazole arylation, but without many details about the statistical methods used.)
</p>

<p>
<a href=https://pubs.acs.org/doi/10.1021/op300275p>A nice paper</a> from Jonathan Moseley and co-workers illustrates why discrete variables are so tricky:
</p>

<blockquote>
How does one compare such different solvents as hexane and DMSO for example? Comparing their relative polarities, which is often related to solubility, might be one way, but this may not be the most important factor for the reaction in question. Additionally, this simple trend may not be relevant in any case, given for example that chlorinated solvents have good solubilising power despite their low-to-medium polarity (as judged by their dielectric constant). On the other hand, the high polarity and solubilising power of alcohols might be compromised in the desired reaction by their protic nature, whilst the “unrelated” hexane and DMSO are both aprotic.
<br><br>
<u>In summary, replacing any one of the discrete parameters with another does not yield a different value on the same axis of a graph, as it would for a continuous parameter; instead it requires a different graph with different axes which may have no meaningful relationship to the first one whatsoever.</u> This means that every single combination of catalyst/ligand/base/solvent is essentially a different reaction for the same two starting materials to produce the same product. <i>(emphasis added)</i>
</blockquote>

<p>
The solution the authors propose is to use principal component analysis (PCA) on molecular descriptors, such as “measurable physical factors (e.g., bp, density, bond length), or calculated and theoretical ones (e.g., electron density, Hansen solubility parameters, Kamlet–Taft solvent polarity parameters),” to convert discrete parameters into continuous ones. This general approach for handling discrete variables—generation of continuous molecular descriptors, followed by use of a dimensionality reduction algorithm—is widely used today for lots of tasks (see for instance <a href=https://pubs.rsc.org/en/content/articlelanding/2016/ob/c5ob01892g>this paper</a> on DoE for solvent screening, and <a href=https://corinwagen.github.io/public/blog/20220926_plotting_diversity.html>my previous post on UMAP</a>).
</p>

<h3>Choosing Intelligent Screening Sets</h3>

<p>
With continuous descriptors for formally discrete variables in hand, a natural next step is to use this data to choose catalyst/substrates that best cover chemical space. (This can be done with several algorithms; see <a href=https://pubs.acs.org/doi/10.1021/jm9700878?ref=PDF>this paper</a> for more discussion) In 2016, this technique was popularized by the Merck <a href=https://pubs.rsc.org/en/content/articlelanding/2016/sc/c5sc04751j>“informer library”</a> approach, which generated sets of aryl boronic esters and aryl halides that could be used to fairly evaluate new reactions against complex, drug-like substrates. (See also <a href=https://pubs.acs.org/doi/full/10.1021/acs.accounts.0c00760>this recent perspective</a> on the Merck informer libraries, and <a href=https://www.pnas.org/doi/full/10.1073/pnas.1409522111>similar work</a> from Matt Sigman a few years earlier.)
</p>

<figure>
  <img class="centered-img" src="../img/20230118_merck_informer.png" style="width:600px;" />
  <figcaption> 
  Illustration of the Merck informer library (yellow) in chemical space, compared to drugs (grey) and compounds from recent literature (blue).
  </figcaption>
</figure>

<p>
While the Merck informer libraries were intended to be shared and used by lots of research groups, recently it’s become more common for individual research groups to design their own project-specific screening sets. Abbie Doyle and co-workers <a href=https://pubs.acs.org/doi/10.1021/jacs.1c12203>kicked this off</a> in 2022 by using DFT-based descriptors, UMAP dimensionality reduction, and agglomerative hierarchical clustering to generate a maximally diverse set of commercial aryl bromides. Other groups soon followed suit: <a href=https://pubs.acs.org/doi/10.1021/acscatal.2c01813>Karl Gademann</a> used this approach to study bromotetrazine cross coupling, while Marion Emmert and co-workers at Merck <a href=https://pubs.acs.org/doi/abs/10.1021/jacs.2c10557>employed similar methods</a> to investigate azole carboxylation. (I’ve also used this approach for substrate selection!)
</p>

<p>
This approach can also be used to design intelligent sets of catalysts/ligands at the outset of a screening project. Using <a href=https://pubs.acs.org/doi/10.1021/jacs.1c09718>their “kraken” dataset of phosphine properties</a>, Tobias Gensch and Matt Sigman <a href=https://pubs.acs.org/doi/10.1021/acscatal.2c01970>proposed a set of 32 commercially available ligands</a> which aims to cover as much of phosphine chemical space as possible in an initial screen. Jason Stevens and co-workers combined this idea with the substrate-selection methods from the previous paragraph to <a href=https://pubs.acs.org/doi/10.1021/acs.organomet.2c00089>perform a detailed study</a> of Ni-catalyzed borylation under many conditions, and tested a variety of ML models on the resulting dataset. (Scott Denmark and co-workers have also used a variant of this idea, called the Universal Training Set, to <a href=https://www.science.org/doi/10.1126/science.aau5631>initialize ML-driven reaction optimization</a>.)
</p>

<h3>New Optimization Algorithms</h3>

<p>
As in every area of life, ML-based approaches have been used a lot for optimization recently. This isn’t new; Klaus Jensen and Steve Buchwald <a href=https://pubs.rsc.org/en/content/articlelanding/2016/RE/C6RE00153J>used machine learning</a> to drive autonomous optimization in 2016, and <a href=https://pubs.acs.org/doi/10.1021/acscentsci.7b00492>Richard Zare</a> published a detailed methodological study in 2017. Nevertheless, as with computational substrate selection, these techniques have come into the mainstream in the past few years.
</p>

<p>
I mentioned the work of Scott Denmark on ML-driven optimization before, and his team published two more papers on this topic last year: <a href=https://pubs.acs.org/doi/10.1021/jacs.2c08820>one on atropselective biaryl iodination</a>, and <a href=https://pubs.acs.org/doi/pdf/10.1021/acs.oprd.1c00155>one on optimization of <i>Cinchona</i> alkaloid-based phase transfer catalysts</a>. In particular, the second paper (conducted in collaboration with scientists at Merck) illustrates how an ML model can be updated with new data as optimization progresses, allowing many sequential rounds of catalyst development to be conducted.
</p>

<p>
Abbie Doyle’s group has done a lot of work on using <a href=https://en.wikipedia.org/wiki/Bayesian_optimization>Bayesian optimization</a> (BO) to drive reaction optimization. <a href=https://www.nature.com/articles/s41586-021-03213-y>Their first paper</a> in this area illustrated the capacity of BO to avoid spurious local minima, and went on to validate this approach in a variety of complex problems. Even better, they compared the results of BO to chemist-guided optimization to see if computer-driven optimization could outcompete expert intuition. To quote the paper:
</p>

<blockquote>
In total, 50 expert chemists and engineers from academia and industry played the reaction optimization game (Fig. 4c). Accordingly, the Bayesian reaction optimizer also played the game 50 times (Fig. 4b), each time starting with a different random initialization. The first point of comparison between human participants and the machine learning optimizer was their raw maximum observed yield at each step during the optimization. Humans made significantly (<i>p</i> &lt; 0.05) better initial choices than random selection, on average discovering conditions that had 15% higher yield in their first batch of experiments. <u>However, even with random initialization, within three batches of five experiments the average performance of the optimizer surpassed that of the humans.</u> Notably, in contrast to human participants, Bayesian optimization achieved &gt;99% yield 100% of the time within the experimental budget. Moreover, Bayesian optimization tended to discover globally optimal conditions (CgMe-PPh, CsOPiv or CsOAc, DMAc, 0.153 M, 105 °C) within the first 50 experiments (Fig. 4b). <i>(emphasis added)</i>
</blockquote>

<figure>
  <img class="centered-img" src="../img/20230118_bayesian_optimization.png" style="width:300px;" />
  <figcaption> 
  Average yield per batch from Bayesian optimization (black) vs. humans (blue), showing how Bayesian optimization outcompetes humans despite a worse start.
  </figcaption>
</figure>

<p>
<a href=https://pubs.acs.org/doi/abs/10.1021/jacs.2c08592>Their subsequent work</a> has made their optimization app available online, and illustrated the application of this strategy to other reactions.
</p>

<p>
Closely related is <a href=https://www.science.org/doi/10.1126/science.adc8743> this work</a> from Aspuru-Guzik, Burke, and co-workers, which uses a “matrix-down” approach to choosing representative substrates for the Suzuki reaction (similar to the substrate-selection algorithms discussed previously). The selected substrates are then subjected to automated high-throughput screening guided by an uncertainty-minimizing ML model (i.e., new reactions are chosen based on the regions of chemical space that the algorithm has the least knowledge about; this is similar to, but distinct from, Bayesian optimization). This is a pretty interesting approach, and I hope they study it further in the future. (Aspuru-Guzik has done <a href=https://arxiv.org/abs/2103.03716>lots of other work</a> in this area, including some <a href=https://pubs.acs.org/doi/10.1021/acscentsci.8b00307>Bayesian optimization</a>.)
</p>

<p>
Finally, two papers this year (that I’m aware of) put forward the idea of using multi-substrate loss functions for optimization: <a href=https://www.nature.com/articles/s41586-022-05263-2>our work on screening for generality</a> and <a href=https://chemrxiv.org/engage/chemrxiv/article-details/636a84ab80c9bf01cc8d95f9>a beautiful collaboration</a> from Song Lin, Scott Miller, and Matt Sigman. These papers used “low-tech” optimization methods that are familiar to practicing organic chemists (e.g. “screen different groups at this position”), but evaluated the output of this optimization not based on the yield/enantioselectivity of a single substrate but on aggregate metrics derived from many substrates. The results that our groups were able to uncover were good, but I’m sure adding robotics and advanced ML optimization will turbocharge this concept and find new and better catalysts with truly remarkable generality.
</p>

<h3>Conclusions</h3>

<p>
Reaction optimization is a common task in organic chemistry, but one that’s commonly done without much metacognition. Instead, many researchers will screen catalysts, substrates, and conditions based on habit or convenience, without necessarily dwelling on whether their screening procedure is optimal. While this may work well enough when you only need to optimize one or two reactions in your whole graduate school career (or when acquiring each data point takes days or weeks), <i>ad hoc</i> strategies will at some point simply fail to scale.
</p>

<p>
Organic chemistry, long the realm of “small data,” is slowly but inexorably catching up with the adjacent sciences. As progress in lab automation and instrumentation makes setting up, purifying, and analyzing large numbers of reactions easier, experimental chemists will have to figure out how to choose which reactions to run and how to handle all the data from these reactions, using tools like the ones discussed above. Like it or not, data science and cheminformatics may soon become core competencies of the modern experimental chemist!
</p>

</div><div class='blogroll-container'><h2><a class='blogroll-title' href='../../public/blog/20230103_hdkie_puzzle.html'>Misleading H/D KIE Experiments</a></h2><i>January 3, 2023</i>
<p>
<i>
Note: old versions of this post lacked a discussion of S<sub>N</sub>2. I've added an appendix which remedies this.
</i>
</p>

<p>
In <a href=https://corinwagen.github.io/public/blog/20220815_rate_determining_span.html>“The Rate-Limiting Span,”</a> I discussed how thinking in terms of the span from ground state to transition state, rather than in terms of elementary steps, can help prevent conceptual errors. Today, I want to illustrate why this is important in the context of a little H/D KIE puzzle. 
</p>

<p>
Consider the following reaction, which could conceivably proceed via an S<sub>N</sub>2 mechanism (red), an S<sub>N</sub>1 mechanism (blue), or really anywhere on the continuum:
</p>

<figure>
  <img class="centered-img" src="../img/20230103_structures.png" style="width:550px;" />
  <figcaption> 
    This is a bit of a silly reaction, admittedly. The intermolecular version or the <i>endo</i> version would have been better.
  </figcaption>
</figure>

<p>
What experiment can be used to investigate the mechanism of this reaction? One possibility is an alpha H/D KIE experiment at the iminium position. Reactions with a sp<sup>3</sup> ground state and an sp<sup>2</sup> transition state display secondary normal alpha H/D KIEs, while reactions with an sp<sup>2</sup> ground state and an sp<sup>3</sup> transition state display secondary inverse KIEs.
Thus, one might think “if iminium formation is rate-limiting, the KIE will be normal, but if alkene addition is rate-limiting, the KIE will be inverse.”
</p>

<p>
Unfortunately this is not true. Instead, all mechanistic possibilities give secondary normal KIEs! I investigated this model system computationally at the wB97X-D/6-31G(d)/SMD(CH<sub>2</sub>Cl<sub>2</sub>) level of theory. Here’s a More O’Ferrall–Jencks plot of the H/D KIE at the iminium position, computed with <a href=https://github.com/ekwan/PyQuiver>PyQuiver</a>
(breaking bond on Y axis, forming bond on X axis): 
</p>

<!--
<figure>
  <img class="centered-img" src="../img/20230103_energy.png" style="width:500px;" />
  <figcaption> 
    Some of the grid points didn't finish, which explains the scattered gaps. I've also excluded anything with energy more than 30 kcal/mol above the ground state.
  </figcaption>
</figure>
-->

<figure>
  <img class="centered-img" src="../img/20230103_kie.png" style="width:550px;" />
  <figcaption> 
    The raw data from PyQuiver is a little fuzzy, so I applied a convolution to smooth the data. Details later on. 
  </figcaption>
</figure>

<p>
Rather than telling us which step is rate-limiting, all the KIE shows us is how much the transition state resembles an iminium ion (bottom right). Structures with long C–Cl bond distances and short C–C bond distances have substantial isotope effects (around 20%), while structures with forming or breaking bonds have smaller isotope effects. 
</p>

<p>
Why is this? Both ionization and addition proceed through iminium-like structures that are substantially sp<sup>2</sup>-hybridized at carbon, irrespective of whether sp<sup>2</sup> character is technically increasing or decreasing in the elementary step. Relative to the starting material, both transition states look like iminium ions and thus lead to large isotope effects. 
</p>

<figure>
  <img class="centered-img" src="../img/20230103_structures2.png" style="width:300px;" />
  <figcaption>
  These both look pretty much like iminium ions.
  </figcaption>
</figure>

<p>
We can also conceptualize this in terms of elementary steps. Taken by itself, alkene addition does lead to an inverse kinetic isotope effect, as seen by the decreasing values as one moves left from the iminium—but an inverse isotope effect relative to the normal equilibrium isotope effect of the iminium. In this system, the equilibrium isotope effect of the iminium is larger than the kinetic isotope effect for alkene addition, and so the combination of these two effects leads to a (smaller) overall normal effect. 
</p>

<p>
(This is the opposite of primary H/D KIEs, where central transition states lead to the largest isotope effects and equilibrium effects are typically small. Here, the isotope effect is mainly a function of hybridization, and so the later the TS, the greater the difference in hybridization and the larger the isotope effect.)
</p>

<p>
In summary, although this experiment seems informative, it’s actually not very useful. It tells you something about the structure of the transition state, but not which step is rate-limiting! In this case, a better experiment would be to measure <sup>13</sup>C KIEs, or an H/D KIE on the nucleophile. 
</p>

<h3>Appendix I: What About S<sub>N</sub>2?</h3>

<p>
On Twitter, <a href="https://twitter.com/LevinChem/status/1610287881993728000">Mark Levin</a> asks about the KIE for the concerted path. I originally meant to include a discussion of this, but then totally forgot to! So let’s fix that.
</p>

<p>
As shown in the graph above, extremely concerted pathways (i.e. going right down the middle of the MOJ plot) will have pretty small isotope effects. These sorts of mechanisms are common where the carbocation would be extremely unstable (methyl iodide) but much less common for stabilized carbocations like we’re discussing here. When oxocarbeniums or iminiums are involved, even “concerted” mechanisms shift towards the bottom right corner: this is the <a href=https://pubs.acs.org/doi/pdf/10.1021/ja506092h>“loose”/“exploded” S<sub>N</sub>2</a> often seen in glycosylation. These pathways will have a modest to large H/D KIE, depending on the exact system and how “exploded” they are (see page 53 of <a href=https://pubs.acs.org/doi/10.1021/jacs.6b10621>this SI</a> for examples)
</p>

<p>
Putting this together, then, what experimental results would be conclusive? A very small KIE would be diagnostic for a “classic” synchronous S<sub>N</sub>2 process, which I consider to be very unlikely here. But medium or large H/D KIEs are consistent with any possibility: S<sub>N</sub>1 with rate-limiting ionization, S<sub>N</sub>1 with rate-limiting nucleophilic attack, or a loose S<sub>N</sub>2. There’s an annulus of different mechanistic possibilities that all give about the same isotope effect, as shown below:
</p>

<figure>
  <img class="centered-img" src="../img/20230103_sn2_plot.png" style="width:470px;" />
  <figcaption> 
  Any TS in the red zone is consistent with a moderately large KIE (say, 15%).
  </figcaption>
</figure>

<p>
To make matters worse, H/D KIEs are pretty tough to simulate quantitatively, because of tunneling, so the annulus isn’t even that precise. That’s why I think this isn’t a very good experiment.
</p>

<h3>Appendix II: Smoothing the KIE Grid</h3>

<p>
The raw KIE values from PyQuiver were pretty noisy, probably because there are small or multiple imaginary frequencies for some of these non-stationary points, so I used convolution to smooth things out a bit. 
</p>

<pre class=code-block>
import numpy as np
from scipy.ndimage import convolve

#### this code block takes a 2d np.ndarray of KIE values 
#### and returns a smoothed np.ndarray with the same dimensions

corner_w = 0.05
edge_w = 0.2
kernel = np.array([
    [corner_w, edge_w, corner_w],
    [edge_w, 1 ,edge_w],
    [corner_w, edge_w, corner_w]
])
kernel = kernel / np.sum(kernel)

smooth_grid = convolve(kie_grid, kernel, mode="nearest")
</pre>

<p>
I haven’t seen this technique used before, but it doesn’t seem unreasonable to me.
</p>
</div><div class='blogroll-container'><h2><a class='blogroll-title' href='../../public/blog/20221231_books.html'>Books from 2022</a></h2><i>December 31, 2022</i>
<p>
Last January, I aimed to read 50 books in 2022. I got through 32, which is at least more than I read in 2021.
</p>

<p>
There’s been a bit of <a href=https://twitter.com/nabeelqu/status/1608874209375313920>discourse</a> around whether setting numerical reading goals for oneself is worthwhile or counterproductive. I don’t have a strong opinion in the abstract, but I noticed that consciously tracking how many books I read served as a little nudge to read more than I would otherwise, without really compromising the quality of books I was reading.
</p>

<p>
In order, then:
</p>

<b>
#1. Neal Stephenson, <i>Snow Crash</i> (reread)
</b>

<p>
I read this in high school, and wanted to read it again in light of recent Metaverse-related discourse. It didn’t disappoint, although it’s a little more “action movie” than Stephenson’s later works.
</p>

<b>
#2. Aristotle, <i>Nicomachean Ethics</i>
</b>
<br>
<b>
#3. Tim Keller, <i>Prayer</i> (reread)
</b>
<br>
<b>
#4–17. Robert Jordan &amp; Brandon Sanderson, <i>Wheel of Time</i>
</b>

<p>
Beyond the surface-level plot (which is fun), <i>Wheel of Time</i> is a fascinating exploration of a number of societies structured around complementarianism at a deep level.
</p>

<b>
#18. Paul Tripp, <i>Parenting</i>
</b>

<br>
<b>
#19. Peter Thiel, <i>Zero To One</i>
</b>

<p>
I’ve discussed this book <a href=https://corinwagen.github.io/public/blog/20220914_zero_to_one.html>previously</a>.
</p>

<b>
#20. Peter Scazzero, <i>Emotionally Healthy Spirituality</i>
</b>

<br>
<b>
#21. Eric Berger, <i>Liftoff</i>
</b>

<p>
This is a good account of the early days of SpaceX, and works well as a book-length answer to the question “What decisions or mindsets allowed Elon Musk to succeed in starting a rocket company when so many other billionaires failed?” or equivalently “What—besides money—explains SpaceX’s success?”
</p>

<p>
My summary, based on the book, would be (in no particular order): (1) a focus on recruiting top talent, (2) a “can-do” spirit / commitment to moving quickly and recklessly, (3) decisive decision-making at top levels of the organization, (4) a willingness to internalize lots of tasks to increase efficiency, and (5) luck.
</p>

<b>
#22. Roald Dahl, <i>Going Solo</i>
</b>
<br>
<b>
#23. Yiyun Li, <i>Must I Go</i>
</b>
<br>
<b>
#24. Tyler Cowen &amp; Daniel Gross, <i>Talent</i>
</b>

<p>
I’ve also discussed this book <a href=https://corinwagen.github.io/public/blog/20220928_talent.html>previously</a>.
</p>

<b>
#25. Stanley Gundry (Ed.), <i>Five Views on Law and Gospel</i>
</b>

<p>
This book presents five different theological “takes” on the relationship between Old Testament law and the New Testament—there was much less consensus than I expected! It is interesting but scholarly, and not an easy read.
</p>

<p>
There are a whole bunch of books in this series; each author writes an essay explaining their position, and then writes brief responses to the other authors’ positions. This format should be more common!
</p>

<b>
#26. Albert Hirschman, <i>Exit, Voice, and Loyalty</i>
</b>

<p>
I discussed pieces of this book <a href="https://corinwagen.github.io/public/blog/20221018_omelas_hirschman_altom.html">here</a>; the rest is also good.
</p>

<b>
#27. Celeste Ng, <i>Little Fires Everywhere</i>
</b>
<br>
<b>
#28. Fuchsia Dunlop, <i>The Food of Sichuan</i>
</b>

<p>
As discussed on <a href=https://conversationswithtyler.com/episodes/fuchsia-dunlop/> Conversations with Tyler</a>.
</p>

<b>
#29. Geoffrey Moore, <i>Crossing The Chasm</i>
</b>

<p>
This book is about 100 pages longer than it needs to be.
</p>

<b>
#30. John Owen, <i>The Mortification of Sin</i> (abridged)
</b>

<p>
As recommended <a href=https://twitter.com/timkellernyc/status/1477975783641595905>by Tim Keller</a>!
</p>

<b>
#31. Margaret Atwood, <i>Oryx and Crake</i>
</b>
<br>
<b>
#32. Alison Weir, <i>The Wars of the Roses</i>
</b>

<p>
This book is a nice account of the Wars of the Roses in the style of a novel; I didn’t know anything beyond the broad strokes, so I found it quite gripping. My biggest complaint is that the book only goes through 1471, and so doesn’t cover any of the Bosworth Field-adjacent events.
</p>

<p>
My reading this year was about 50% fiction (18 books), with the remainder mostly divided between business (5 books) and Christianity (5 books). My main goal for next year is to read more history; I didn’t end up reading very much history this year, and I miss it.
</p>

</div><div class='blogroll-container'><h2><a class='blogroll-title' href='../../public/blog/20221228_boltzmann_error.html'>Evaluating Error in Boltzmann Weighting</a></h2><i>December 28, 2022</i>
<p>
A technique that I’ve seen employed more and more in computational papers over the past few years is to calculate Boltzmann-weighted averages of some property over a conformational ensemble. This is potentially very useful because most complex molecules exist in a plethora of conformations, and so just considering the lowest energy conformer might be totally irrelevant. 
To quote a <a href=https://onlinelibrary.wiley.com/doi/full/10.1002/anie.202205735>recent perspective</a> from Grimme and friends:
</p>

<blockquote>
For highly flexible structures, a molecular property, such as energy, nuclear magnetic resonance spectra, or optical rotation values may not be sufficiently described by a single structure. At finite temperatures, various conformers are populated and the overall property must be described as thermal average over the unique property values of each conformer.
</blockquote>

<p>
What's been bothering me about this, however, is that Boltzmann weights are calculated as <i>e</i> to the power of the relative energy:
</p>

<pre class=code-block>
def boltzmann_weight(conformer_properties, conformer_energies, temp=298):
    """ Some simple Python code to calculate Boltzmann weights. """

    energies = conformer_energies - np.min(conformer_energies)

    R = 3.1668105e-6 # eH/K
    weights = np.exp(-1*energies/(627.509*R*temp))
    weights = weights / np.sum(weights)

    return weights, np.average(conformer_properties, weights=weights)
</pre>

<p>
Since relative energies of conformers are usually calculated with only middling accuracy (±0.2 kcal/mol with <a href=https://pubs.rsc.org/en/content/articlelanding/2011/cp/c0cp02984j>common methods</a>), we’re taking the exponential of a potentially inaccurate value—which seems bad from the standpoint of error propagation!
</p>

<figure>
  <img class=centered-img src=../img/20221228_xkcd.png style="width:375px;" />
  <figcaption>
  Excerpt from <a href="https://xkcd.com/2295/">xkcd</a>, on error propagation (line #3 is what's relevant here).
  </figcaption>
</figure>

<p>
Grimme and co-authors address this point explicitly in their review:
</p>

<blockquote>
At the same time, however, conformational energies need to be accurate to within about 0.1–0.2 kcal mol<sup>−1</sup> to predict Boltzmann populations at room temperature reasonably well. This is particularly important since properties can vary strongly and even qualitatively between populated conformers…
</blockquote>

<p>
Although the best answer is, of course, to just get more accurate energies, it's not always practical to do that in the real world.
If we take imperfect energies as our starting point, what's the best strategy to pursue?
</p>

<p>
One could imagine a scenario in which error causes relatively unimportant conformers to end up with large weights, making the answer even worse than the naïve approach would have been. If the lowest energy conformer accounts for 60-70% of the answer, might it be best to just stick with that, instead of trying to throw in some messy corrections?
</p>

<p>
To test this, I drew a random flexible-looking molecule with a few functional groups, conducted a conformational search using <i>crest</i>, and then optimized it and calculated <sup>19</sup>F NMR shieldings using wB97X-D/6-31G(d). (There are <a href=https://pubs.acs.org/doi/abs/10.1021/acs.jctc.8b00624>better NMR methods</a> out there, but the absolute accuracy of the shift isn’t really the point here.)
</p>

<figure>
  <img class=centered-img src=../img/20221228_cylview.png style="width:350px;" />
  <figcaption>
  The lowest energy conformer of the molecule I drew (3-fluorohex-5-enal).
  </figcaption>
</figure>

<p>
I then computed more accurate energies using DLPNO-CCSD(T)/cc-pVTZ, and compared the results from Boltzmann weighting with DFT and coupled-cluster energies.
(<sup>19</sup>F values are just the isotropic shielding tensor, and energies are in kcal/mol.)
</p>

<table>
  <tr>
    <th>Conformer</th> 
    <th><sup>19</sup>F shift</th> 
    <th>DFT energy</th>
    <th>DFT weight</th>
    <th>CC energy</th>
    <th>CC weight</th>
  </tr>
  <tr><td>c00003</td><td>401.76</td><td>0.00</td><td>0.624</td><td>0.00</td><td>0.529</td></tr>
  <tr><td>c00001</td><td>403.08</td><td>1.02</td><td>0.112</td><td>0.68</td><td>0.167</td></tr>
  <tr><td>c00010</td><td>396.63</td><td>1.12</td><td>0.093</td><td>1.10</td><td>0.083</td></tr>
  <tr><td>c00007</td><td>391.45</td><td>1.56</td><td>0.045</td><td>1.54</td><td>0.039</td></tr>
  <tr><td>c00004</td><td>396.77</td><td>1.82</td><td>0.029</td><td>1.64</td><td>0.033</td></tr>
  <tr><td>c00006</td><td>400.16</td><td>2.31</td><td>0.013</td><td>1.75</td><td>0.028</td></tr>
  <tr><td>c00029</td><td>400.37</td><td>2.36</td><td>0.012</td><td>1.75</td><td>0.028</td></tr>
  <tr><td>c00032</td><td>393.96</td><td>2.05</td><td>0.020</td><td>1.76</td><td>0.027</td></tr>
  <tr><td>c00027</td><td>394.60</td><td>2.54</td><td>0.009</td><td>2.21</td><td>0.013</td></tr>
  <tr><td>c00017</td><td>394.69</td><td>3.12</td><td>0.003</td><td>2.27</td><td>0.011</td></tr>
  <tr><td>c00018</td><td>402.24</td><td>2.24</td><td>0.014</td><td>2.35</td><td>0.010</td></tr>
  <tr><td>c00011</td><td>381.31</td><td>2.59</td><td>0.008</td><td>2.49</td><td>0.008</td></tr>
  <tr><td>c00023</td><td>388.77</td><td>2.51</td><td>0.009</td><td>2.54</td><td>0.007</td></tr>
  <tr><td>c00013</td><td>390.32</td><td>3.02</td><td>0.004</td><td>2.61</td><td>0.006</td></tr>
  <tr><td>c00020</td><td>394.97</td><td>3.23</td><td>0.003</td><td>2.62</td><td>0.006</td></tr>
  <tr><td>c00015</td><td>398.24</td><td>3.02</td><td>0.004</td><td>2.97</td><td>0.004</td></tr>
  <tr><td>&nbsp;</td><td></td><td></td><td></td><td></td><td></td><tr>
  <tr><th>Final <sup>19</sup>F Shift</th><td></td><td></td><td>400.20</td><td></td><td>400.13</td></tr>
</table>

<p>
The match is really quite good, much better than just guessing the lowest energy conformer would have been! This is despite having a decent number of low-energy conformers, so I don’t think this is a particularly rigged case.
</p>

<p>
But, what if we just got lucky in this case? The relative energies are off by 0.28 kcal/mol on average. If we simulate adding 0.28 kcal/mol of error to each of the “true” energies a bunch of times, we can see how well Boltzmann weighting does on average, even with potentially unlucky combinations of errors.
</p>

<figure>
  <img class=centered-img src=../img/20221228_randomShifts.png style="width:400px;" />
  <figcaption>
  Shifts from 100,000 simulations with random error added to CCSD(T) energies.
  </figcaption>
</figure>

<p>
The above image shows the predicted shift from 100,000 different randomly generated sets of “wrong” energies. We can see that the Boltzmann-weighted value is almost always closer to the true value than the shift of the major conformer is (99.01% of the time, to be precise). This is despite substantial changes in the weight of the major conformer:
</p>

<figure>
  <img class=centered-img src=../img/20221228_randomWeights.png style="width:400px;" />
  <figcaption>
  Major conformer weights from 100,000 simulations with random error added to CCSD(T) energies.
  </figcaption>
</figure>

<p>
Thus, we can see that Boltzmann weighting is relatively resistant to random errors in this case. Although this is only one molecule, and no doubt scenarios can be devised where inaccurate energies lead to ludicrously incorrect predictions, this little exercise has helped temper my skepticism of Boltzmann weighting.
</p>

<i>
Thanks to Eugene Kwan and Joe Gair for discussions around these topics over the past few years. Data available upon request.
</i>

</div><div class='previous-link'><a href='blog_p1.html'>previous page</a></div><div class='next-link'><a href='blog_p3.html'>next page</a></div><br>
  </body>
  <br>
  <footer>
    <a href="mailto:cwagen@g.harvard.edu">email</a>
    <a href="https://github.com/corinwagen">github</a>
    <a href="https://twitter.com/CorinWagen">twitter</a>
    <div style="float:right;">
      <a href="/rss.xml">blog rss feed</a>
    </div>
  </footer>
</html>
